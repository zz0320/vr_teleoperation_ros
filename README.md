# 星海图R1 VR远程操作ROS系统

这是一个基于ROS（机器人操作系统）的虚拟现实远程操作系统，专为**星海图R1**机器人设计。该系统采用**绝对值遥操作**方式，允许用户通过VR设备实时精确控制机器人的动作，包括手臂、抓取器、底盘和躯干的移动。

## 功能特点

- 专为星海图R1机器人定制的VR遥操作解决方案
- 绝对值遥操作模式，提供高精度的操作体验
- VR数据接收和处理
- 机器人命令发布
- 逆运动学求解（使用relaxed IK）
- 双臂（左右）控制支持
- 智能语音反馈，提供操作状态提示

## 绝对值遥操作说明

本系统采用绝对值遥操作模式，实现操作者动作与机器人动作的一对一映射。与相对值操作不同，绝对值遥操作能够：

- 精确复现操作者手部位置和姿态
- 提供直观的空间控制体验
- 减少操作学习成本
- 适合精细操作任务

## 控制模式

系统支持三种控制模式，可以针对不同任务灵活切换：

| 模式 | 描述 | 主要功能 |
|------|------|---------|
| 模式0 | 手臂控制模式 | 直接控制机器人手臂位置和姿态，实现精确操作 |
| 模式1 | 躯干控制模式 | 控制机器人躯干的各个关节，包括腰部旋转和前后倾斜 |
| 模式2 | 底盘控制模式 | 控制机器人底盘的移动和转向，用于大范围位置调整 |

### 默认模式和切换

- **默认模式**：系统默认启动在模式0（手臂控制模式）
- **模式切换**：模式切换主要在VR应用程序（Unity端）中实现
  - 首次使用时，系统要求在模式0下启动
  - 如果不在模式0，系统会提示"THE INITIAL MODE IS NOT ZERO! PLEASE PRESS 2 STICKS TO ZERO IT!"
  - 可能需要同时按下左右手柄的摇杆按钮来重置到模式0
  - 在VR界面中查找专门的模式切换菜单或按钮组合来切换不同模式

## 按键指南

### VR控制器按键 - 通用功能

参考链接：https://galaxea.ai/zh/Guide/R1/R1_VR_Teleop_Usage_Tutorial/#75

| 按键 | 功能 |
|------|------|
| 侧面扳机键 (Side Trigger) | 激活手臂控制（按住时进行手臂移动） |
| 前置扳机键 (Front Trigger) | 数据录制控制（按住超过2秒触发）：<br>- 左手：开始数据录制并播放语音提示<br>- 右手：结束数据录制并播放语音提示 |
| 左手X按钮 | 控制左手抓取器开合（切换状态） |
| 右手A按钮 | 控制右手抓取器开合（切换状态） |
| 左手Y按钮 | 重置左手位置 |
| 右手B按钮 | 重置右手位置 |

### 模式0 - 手臂控制模式

在此模式下，VR控制器的位置和姿态直接映射到机器人手臂：

- 控制器位置与头部位置的相对关系决定手臂位置
- 控制器旋转决定机器人手部姿态
- 需要按住侧面扳机键(Side Trigger)才能激活手臂移动

### 模式1 - 躯干控制模式

| 按键 | 功能 |
|------|------|
| 右手前置按钮 (Front) | 腰部向右转 |
| 右手侧面按钮 (Side) | 腰部向左转 |
| 左手拇指摇杆上推 | 躯干向下移动 |
| 左手拇指摇杆下拉 | 躯干向上移动 |
| 右手拇指摇杆上推 | 躯干前倾 |
| 右手拇指摇杆下拉 | 躯干后仰 |

### 模式2 - 底盘控制模式

| 按键 | 功能 |
|------|------|
| 左手拇指摇杆上推 | 机器人前进 |
| 左手拇指摇杆下拉 | 机器人后退 |
| 右手拇指摇杆左推 | 机器人左转 |
| 右手拇指摇杆右推 | 机器人右转 |
| 右手侧面按钮与前置按钮 | 控制旋转速度 |

## 操作技巧

1. **初始化操作**：首次使用时，系统要求在模式0下启动。如果不在模式0，系统会提示"THE INITIAL MODE IS NOT ZERO! PLEASE PRESS 2 STICKS TO ZERO IT!"

2. **手臂控制**：
   - 控制器位置与机器人手臂位置之间采用比例映射，比例为`ARM_LENGTH / HUMAN_LENGTH` (约1.25倍)
   - 系统对控制器输入进行平滑处理，公式为：`new_position = 0.5 * current_position + 0.5 * last_position`
   - 四元数插值用于平滑旋转：`Quaternion.slerp(last_quat, current_quat, 0.5)`

3. **躯干控制**：
   - 腰部旋转速度系数：0.2
   - 前后倾斜速度系数：0.1
   - 控制机制通过直接修改关节位置实现，第3个关节控制前后倾斜，第4个关节控制左右旋转

4. **底盘速度控制**：
   - 线性速度比例系数：0.2
   - 角速度比例系数：0.4

5. **数据录制与语音反馈**：
   - 按住左手前置扳机键超过2秒可开始数据录制，系统会播放开始录制的语音提示
   - 按住右手前置扳机键超过2秒可结束数据录制，系统会播放结束录制的语音提示
   - 语音提示仅在数据录制操作成功时播放，避免误操作时的错误提示

6. **绝对值映射**：
   - 系统使用Unity到机器人坐标系的转换矩阵进行精确坐标映射
   - 坐标变换矩阵：
     ```
     [0.0, 0.0, 1.0]
     [-1.0, 0.0, 0.0]
     [0.0, 1.0, 0.0]
     ```

## 技术实现

### 语音反馈实现

系统集成了智能语音反馈机制，为操作者提供实时状态提示：

1. **语音播报与录制状态精确匹配**：
   - 在`vr_ros_adapter.py`中，`publish_data_collection_command`函数处理语音播报
   - 系统在成功调用对应ROS服务后才播放语音提示，确保操作状态与语音反馈一致
   - 使用`play_voice_notification`函数统一处理不同类型的语音提示

2. **触发机制**：
   - 在`vr_data_receiver.py`中检测用户是否按住前置扳机键超过2秒
   - 左手前置扳机键触发开始录制服务(`/start_data_collection`)
   - 右手前置扳机键触发结束录制服务(`/stop_data_collection`)

3. **语音文件**：
   - 开始录制：`/voice/start.mp3`
   - 结束录制：`/voice/end.mp3`

### 躯干控制实现

躯干控制主要在以下文件中实现：

1. **src/vr_client_node/vr_ros_adapter.py**
   - `publish_torso_command`函数实现了躯干控制命令的发布
   - 通过`/motion_target/target_joint_state_torso`话题发送躯干关节位置命令

2. **src/vr_client_node/robot_cmd_publisher.py**
   - `parse_torso`函数解析VR控制器输入，转换为躯干控制命令
   - 处理模式1中的躯干控制参数

3. **通信接口**
   - 躯干状态反馈：`/hdas/feedback_torso`
   - 躯干目标关节状态：`/motion_target/target_joint_state_torso`
   - 直接控制躯干：`/motion_control/control_torso`

## 项目结构

```